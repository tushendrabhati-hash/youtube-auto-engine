name: YouTube Auto Upload

on:
  workflow_dispatch:
  schedule:
    # Daily 5:30 PM IST (12:00 UTC)
    - cron: '0 12 * * *'

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:

    # ------------------------------
    # Checkout Repository
    # ------------------------------
    - name: Checkout repo
      uses: actions/checkout@v3

    # ------------------------------
    # Install Dependencies
    # ------------------------------
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install ffmpeg -y
        pip install google-api-python-client \
                    google-auth \
                    google-auth-oauthlib \
                    feedparser \
                    yt-dlp

    # ------------------------------
    # Detect New Videos (PHASE 3)
    # ------------------------------
    - name: Detect new videos
  run: python detect.py | tee detect.log

    - name: Download detected video
      run: python download.py
 
    # ------------------------------
    # Random Upload Delay
    # Upload happens between 6â€“8 PM IST
    # ------------------------------
    - name: Random upload delay
      run: |
        echo "Waiting random time before upload..."
        DELAY=$((RANDOM % 7200))
        echo "Sleeping for $DELAY seconds"
        sleep $DELAY

    # ------------------------------
    # Upload to YouTube
    # ------------------------------
    - name: Upload to YouTube
      env:
        YT_CREDENTIALS: ${{ secrets.YT_CREDENTIALS }}
      run: python Upload.py
