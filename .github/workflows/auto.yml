name: YouTube Network Engine

on:
  workflow_dispatch:
  schedule:
    - cron: '0 12 * * *'   # Daily run (5:30 PM IST)

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:

    # -----------------------------
    # Checkout Repository
    # -----------------------------
    - name: Checkout repo
      uses: actions/checkout@v3


    # -----------------------------
    # Install Dependencies
    # -----------------------------
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install ffmpeg -y
        pip install google-api-python-client \
                    google-auth \
                    google-auth-oauthlib \
                    feedparser \
                    yt-dlp


    # -----------------------------
    # Create cookies.txt from secret
    # -----------------------------
    - name: Create cookies file
      run: echo "${{ secrets.YT_COOKIES }}" > cookies.txt


    # -----------------------------
    # Detect latest video
    # -----------------------------
    - name: Detect videos
      run: python detect.py | tee detect.log


    # -----------------------------
    # Download video
    # -----------------------------
    - name: Download video
      run: python download.py


    # -----------------------------
    # Create variations (multi upload)
    # -----------------------------
    - name: Create variations
      run: python variation.py


    # -----------------------------
    # Generate metadata
    # -----------------------------
    - name: Generate metadata
      run: python metadata.py


    # -----------------------------
    # Random delay (6â€“8 PM IST)
    # -----------------------------
    - name: Random upload delay
      run: |
        echo "Waiting random time..."
        DELAY=$((RANDOM % 7200))
        sleep $DELAY


    # -----------------------------
    # Upload videos
    # -----------------------------
    - name: Upload to YouTube
      env:
        YT_CREDENTIALS: ${{ secrets.YT_CREDENTIALS }}
      run: python Upload.py


    # -----------------------------
    # Learning update
    # -----------------------------
    - name: Update learning system
      run: python analytics.py
